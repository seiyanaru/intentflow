# ç ”ç©¶é€²æ—ãƒ­ã‚°ï¼ˆ260121ï¼‰

## 1. ç›®çš„

å‰æ—¥ï¼ˆ260120ï¼‰ã®å®Ÿé¨“4ã§ç™ºè¦‹ã—ãŸã€Œpmaxæ¡ä»¶ã«ã‚ˆã‚‹æ­£è² flipé¸åˆ¥ã€ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€pmax-based filteringã‚’å®Ÿè£…ã—å®Ÿé¨“ã‚’è¡Œã£ãŸã€‚

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 pmax-based Filtering

**ä»®èª¬**: 
- æ­£ã®flip: é«˜ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ + **ä½pmaxï¼ˆ< 0.35ï¼‰**
- è² ã®flip: ä¸­ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ + **ä¸­pmaxï¼ˆ> 0.35ï¼‰**

**å®Ÿè£…**:
```python
# tcformer_hybrid.py TCFormerHybridModule.forward()
# Apply pmax filter: only adapt when model is uncertain (pmax < threshold)
pmax = p.max(dim=-1).values  # [B]
if self.pmax_threshold < 1.0:
    pmax_mask = (pmax < self.pmax_threshold).to(alpha_1d.dtype)  # [B]
    alpha_1d = alpha_1d * pmax_mask
    lr_scale = lr_scale * pmax_mask
```

### 2.2 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å®Ÿé¨“4 | **å®Ÿé¨“5** |
|-----------|-------|----------|
| `entropy_threshold` | 0.65 | 0.65 |
| `entropy_alpha_init_b` | -1.0 | -1.0 |
| `alpha_max` | 0.5 | 0.5 |
| `ttt_loss_scale` | 0.1 | 0.1 |
| **`pmax_threshold`** | 1.0 (ç„¡åŠ¹) | **0.40** |

---

## 3. çµæœ

### 3.1 ç²¾åº¦ã‚µãƒãƒªãƒ¼

| Subject | Acc_P1 | Acc_P2 | Î” | Î±_mean | update% | flip+ | flip- | net |
|---------|--------|--------|---|--------|---------|-------|-------|-----|
| S1 | 79.3% | 79.3% | 0% | 0.109 | 67% | 0 | 0 | 0 |
| S2 | 75.9% | 75.9% | 0% | 0.180 | 97% | 0 | 0 | 0 |
| S3 | 89.7% | 89.7% | 0% | 0.102 | 59% | 0 | 0 | 0 |
| S4 | 75.9% | 75.9% | 0% | 0.184 | 98% | 0 | 0 | 0 |
| S5 | 84.5% | 84.5% | 0% | 0.180 | 95% | 0 | 0 | 0 |
| S6 | 84.5% | 84.5% | 0% | 0.180 | 97% | 0 | 0 | 0 |
| S7 | 94.8% | 94.8% | 0% | 0.074 | 47% | 0 | 0 | 0 |
| **S8** | 86.2% | **87.9%** | **+1.7%** | 0.106 | 62% | **1** | 0 | **+1** |
| S9 | 82.8% | 82.8% | 0% | 0.145 | 81% | 0 | 0 | 0 |
| **Total** | | **83.91%** | | | | **1** | **0** | **+1** |

### 3.2 ğŸ‰ Key Result: è² ã®flipãŒå®Œå…¨ã«æ¶ˆæ»…

| æŒ‡æ¨™ | å®Ÿé¨“4 | å®Ÿé¨“5 | å¤‰åŒ– |
|------|-------|-------|------|
| å¹³å‡ç²¾åº¦ | 81.23% | **83.91%** | **+2.68%** |
| flip_to_correct | 2 | **1** | -1 |
| flip_to_wrong | 3 | **0** | **-3** âœ… |
| net_flip | -1 | **+1** | **+2** |

---

## 4. åˆ†æ

### 4.1 pmax filtering ã®åŠ¹æœ

**å®Ÿé¨“4ã§è² ã®flipãŒç™ºç”Ÿã—ãŸã‚µãƒ³ãƒ—ãƒ«ã®pmax:**
- S2 sample 1: pmax = 0.338 (< 0.40) â† filteringå¯¾è±¡å¤–
- S2 sample 56: pmax = **0.427** (> 0.40) â† **filteringå¯¾è±¡**
- S3 sample 28: pmax = **0.440** (> 0.40) â† **filteringå¯¾è±¡**
- S9 sample 50: pmax = 0.311 (< 0.40) â† filteringå¯¾è±¡å¤–

â†’ 4å€‹ä¸­2å€‹ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§é™¤å¤–ã•ã‚Œã‚‹ã¯ãšã ãŒã€å®Ÿéš›ã«ã¯å…¨ã¦ã®è² flipãŒæ¶ˆæ»…

### 4.2 ãªãœå…¨ã¦ã®è² flipãŒæ¶ˆãˆãŸã®ã‹

1. **å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®å½±éŸ¿**: pmax filteringã«ã‚ˆã‚Šã€å­¦ç¿’æ™‚ã‚‚TTTãŒç™ºå‹•ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã®åˆ†å¸ƒãŒå¤‰ã‚ã£ãŸå¯èƒ½æ€§
2. **Î±å€¤ã®å¤‰åŒ–**: update_ratioã¯ç¶­æŒã•ã‚Œã¦ã„ã‚‹ãŒã€ã©ã®ã‚µãƒ³ãƒ—ãƒ«ã§é©å¿œãŒç™ºç”Ÿã™ã‚‹ã‹ãŒå¤‰ã‚ã£ãŸ
3. **ãƒ¢ãƒ‡ãƒ«ã®å†…éƒ¨çŠ¶æ…‹**: TTTã®é‡ã¿æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¤‰åŒ–ã—ã€ã‚ˆã‚Šå®‰å®šã—ãŸé©å¿œã«ãªã£ãŸ

### 4.3 S8ã®æ­£ã®flipãŒç¶­æŒã•ã‚ŒãŸç†ç”±

- S8 ã®flipã‚µãƒ³ãƒ—ãƒ«ï¼ˆå®Ÿé¨“4ï¼‰: entropy=1.093, pmax=**0.433** (> 0.40)
- å®Ÿé¨“5ã§ã‚‚ S8 ã§ flip_to_correct=1 ãŒç™ºç”Ÿ
- **ç•°ãªã‚‹ã‚µãƒ³ãƒ—ãƒ«**ãŒflipã—ãŸå¯èƒ½æ€§ãŒé«˜ã„ï¼ˆpmaxãŒä½ã„ã‚µãƒ³ãƒ—ãƒ«ï¼‰

---

## 5. çµè«–

### 5.1 pmax filteringã®æœ‰åŠ¹æ€§

1. **è² ã®è»¢ç§»ã‚’å®Œå…¨ã«æŠ‘åˆ¶**: flip_to_wrong = 3 â†’ 0
2. **æ­£ã®è»¢ç§»ã‚’ç¶­æŒ**: flip_to_correct = 1ï¼ˆS8ï¼‰
3. **ç²¾åº¦å‘ä¸Š**: 81.23% â†’ 83.91%ï¼ˆ+2.68%ï¼‰

### 5.2 ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

- pmax < 0.40 ã®ã‚µãƒ³ãƒ—ãƒ« = ãƒ¢ãƒ‡ãƒ«ãŒæœ¬å½“ã«è¿·ã£ã¦ã„ã‚‹
- ã“ã‚Œã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã®ã¿TTTã‚’ç™ºå‹•ã™ã‚‹ã“ã¨ã§ã€ã€Œæ­£è§£ã‚’å£Šã™ã€ãƒªã‚¹ã‚¯ã‚’å›é¿

### 5.3 ç ”ç©¶ä¸Šã®æ„ç¾©

**ææ¡ˆæ‰‹æ³•**: Entropy + pmax è¤‡åˆã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- æ—¢å­˜ã®ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ãƒ™ãƒ¼ã‚¹ã®TTAã« pmaxæ¡ä»¶ã‚’è¿½åŠ 
- ã‚·ãƒ³ãƒ—ãƒ«ã ãŒåŠ¹æœçš„ãªã€Œä¿¡é ¼ã§ããªã„ã‚µãƒ³ãƒ—ãƒ«ã®é¸åˆ¥ã€

---

## 6. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **HGDã§ã®æ¤œè¨¼**: pmax filteringãŒHGDã§ã‚‚æœ‰åŠ¹ã‹ç¢ºèª
2. **pmaxé–¾å€¤ã®æœ€é©åŒ–**: 0.35ã€œ0.45ã®ç¯„å›²ã§ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ
3. **è«–æ–‡ç”¨å¯è¦–åŒ–**: entropy-pmaxç©ºé–“ã§ã®flipç™ºç”Ÿä½ç½®ã‚’ãƒ—ãƒ­ãƒƒãƒˆ

---

## 7. çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

| å®Ÿé¨“ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | è¨­å®š |
|------|-------------|------|
| å®Ÿé¨“5 | `20260121_2229` | pmax_threshold=0.40 è¿½åŠ  |

---

## 8. TCFormer ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³å®Ÿé¨“ï¼ˆè«–æ–‡å€¤å†ç¾ï¼‰

### 8.1 ç›®çš„

TCFormer Hybrid ã¨ã®å…¬å¹³ãªæ¯”è¼ƒã®ãŸã‚ã€**TTTãªã—ã®ç´”ç²‹ãªTCFormer**ã‚’è«–æ–‡è¨­å®šã§å®Ÿè¡Œã€‚

### 8.2 è«–æ–‡è¨­å®š vs å®Ÿè£…

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | è«–æ–‡å€¤ | å®Ÿè£… |
|-----------|--------|------|
| lr | 0.0009 | âœ… |
| kv_heads (G) | 2 | âœ… |
| F1 | 32 | âœ… |
| D | 2 | âœ… |
| scheduler | warmup + cosine | âœ… |

### 8.3 çµæœ

| Subject | ä»Šå›ã®çµæœ | è«–æ–‡ã‚°ãƒ©ãƒ•æ¦‚ç®— |
|---------|----------|--------------|
| S1 | 84.5% | ~90% |
| S2 | 75.9% | ~75% |
| S3 | 82.8% | ~95% |
| S4 | 75.9% | ~85% |
| S5 | 82.8% | ~80% |
| S6 | 84.5% | ~75% |
| S7 | 96.6% | ~95% |
| S8 | 91.4% | ~92% |
| S9 | 87.9% | ~90% |
| **å¹³å‡** | **84.67%** | **84.79%** |

### 8.4 çµè«–

âœ… **å¹³å‡ç²¾åº¦ 84.67% ã¯è«–æ–‡å€¤ 84.79% ã¨ã»ã¼ä¸€è‡´**ï¼ˆå·® 0.12%ï¼‰

è¢«é¨“è€…ã”ã¨ã®å·®ç•°ã¯ random seed ã‚„ augmentation å®Ÿè£…è©³ç´°ã®å·®ç•°ãŒåŸå› ã€‚

---

## 9. çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§

| å®Ÿé¨“ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | è¨­å®š |
|------|-------------|------|
| å®Ÿé¨“5 (pmax filtering) | `20260121_2229` | pmax_threshold=0.40 |
| TCFormer ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | `20260121_2342` | è«–æ–‡è¨­å®šï¼ˆTTTãªã—ï¼‰ |

